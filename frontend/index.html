<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaire MDM</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f0f0; }
        h1 { color: #333; }
        table { border-collapse: collapse; width: 100%; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        th:hover { background-color: #ddd; }
        .button { margin: 20px 10px 20px 0; padding: 10px 20px; font-size: 16px; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .qr-button { background-color: #4CAF50; }
        .qr-button:hover { background-color: #45a049; }
        .logout-button { background-color: #f44336; }
        .logout-button:hover { background-color: #d32f2f; }
        #qrCodeModal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; text-align: center; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Inventaire des appareils MDM</h1>
    <div>
        <button class="button qr-button" onclick="showQRCode()">Enrôler un appareil via QR Code</button>
        <button class="button logout-button" onclick="logout()">Déconnexion</button>
    </div>
    <table id="deviceTable">
        <thead>
            <tr>
                <th onclick="sortTable(0)">ID</th>
                <th onclick="sortTable(1)">IMEI</th>
                <th onclick="sortTable(2)">Marque</th>
                <th onclick="sortTable(3)">Modèle</th>
                <th onclick="sortTable(4)">Version OS</th>
                <th onclick="sortTable(5)">Dernier check-in</th>
                <th onclick="sortTable(6)">Statut</th>
            </tr>
        </thead>
        <tbody id="deviceTableBody">
            <!-- Les données seront insérées ici dynamiquement -->
        </tbody>
    </table>

    <div id="qrCodeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Scannez ce QR code pour enrôler un appareil</h2>
            <div id="qrCodeContainer"></div>
            <p id="enrollmentCode"></p>
        </div>
    </div>

    <script>
        // Fonction de vérification de l'authentification
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return null;
            }
            return token;
        }

        async function fetchDevices() {
            const token = checkAuth(); // Vérifie l'authentification
            if (!token) return;

            const response = await fetch('/api/devices', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const devices = await response.json();
                const tableBody = document.getElementById('deviceTableBody');
                devices.forEach(device => {
                    const row = `<tr><td>${device.id}</td><td>${device.imei}</td><td>${device.brand}</td><td>${device.model}</td><td>${device.osVersion}</td><td>${device.lastCheckin}</td><td>${device.status}</td></tr>`;
                    tableBody.innerHTML += row;
                });
            } else {
                console.error('Erreur lors de la récupération des appareils:', response.statusText);
            }
        }

        function showQRCode() {
            const enrollmentCode = "votre_code_d_enrôlement"; // Remplacez par le code réel
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            qrCodeContainer.innerHTML = ''; // Réinitialise le conteneur

            const qr = qrcode(0, 'H');
            qr.addData(enrollmentCode);
            qr.make();
            qrCodeContainer.innerHTML = qr.createImgTag();

            document.getElementById('qrCodeModal').style.display = 'block';
        }

        document.querySelector('.close').onclick = function() {
            document.getElementById('qrCodeModal').style.display = 'none';
        };

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }

        window.onload = fetchDevices;
    </script>

</body>
</html>